# Pocket Bot

Телеграм-бот, который запускается с выбором языка, проверяет подписку пользователя на обязательные ресурсы, собирает Pocket Option ID и маршрутизирует заявку на обработку администраторам. Интерфейс построен в формате «одно окно»: перед показом нового экрана бот удаляет предыдущие сообщения, поэтому на экране всегда остаётся только актуальное состояние. После одобрения пользователь получает главное меню с навигацией.

## Подготовка окружения

1. Создайте и активируйте виртуальное окружение Python 3.10+.
2. Установите зависимости:

```powershell
pip install -r requirements.txt
```

   > **Важно.** Для автоматических сигналов требуется пакет `python-telegram-bot` с поддержкой JobQueue. Файл `requirements.txt` уже запрашивает вариант с extra `job-queue`; если вы устанавливаете зависимости вручную, обязательно используйте `pip install "python-telegram-bot[job-queue]==21.4"`.

3. Укажите токен бота, не публикуя его в репозиториях.
   - Самый простой способ — создать файл `.env` в корне проекта со строкой:

```
POCKET_BOT_TOKEN=ваш_секретный_токен
```

   - Альтернативно можно выставить переменную окружения `POCKET_BOT_TOKEN` или `TELEGRAM_BOT_TOKEN` вручную.
4. (Опционально) задайте ID администраторов, которые получат доступ к модерации заявок. Используйте переменную окружения `POCKET_BOT_ADMIN_IDS` (список числовых ID через запятую) либо добавьте строку в `.env`:

```
POCKET_BOT_ADMIN_IDS=123456789,987654321
```
5. Настройте подключение к базе данных. По умолчанию бот использует файл `data/pocket_bot.sqlite3`. Чтобы подключить удалённую MySQL-базу, добавьте переменную окружения `POCKET_BOT_DB_URL` или строку в `.env` в формате:

```
POCKET_BOT_DB_URL=mysql://<user>:<password>@<host>:<port>/<database>?charset=utf8mb4
```

Например, для хостинга Ukraine.com.ua:

```
POCKET_BOT_DB_URL=mysql://ff597889_tgbot:_2mD6cBt*5@ff597889.mysql.tools:3306/ff597889_tgbot?charset=utf8mb4
```

Не забудьте добавить IP-адрес сервера, где запускается бот, в раздел «Список дозволених IP» панели управления хостингом, иначе подключение будет заблокировано.

## Запуск бота

Из корня репозитория выполните:

```powershell
python main.py
```

Скрипт автоматически добавит каталог `src` в `PYTHONPATH`, соберёт приложение и запустит polling.

### Пользовательский сценарий

1. Команда `/start` отправляет изображение `language.png` и две кнопки выбора языка (Русский, English).
2. После выбора языка бот предлагает подписаться на чат и канал, выводя кнопки-ссылки и кнопку «Проверить подписку».
3. При успешной проверке подписки бот просит ввести Pocket Option ID и фиксирует заявку, сообщая «Ваша заявка в обработке, ожидайте».
4. После одобрения администратором пользователю приходит уведомление и главное меню с изображением `main.png`. В меню доступны кнопки «Сообщество», «Поддержка», «Рабочая область», «Поменять язык».
   - Разделы «Сообщество» и «Поддержка» содержат соответствующие материалы и кнопку «Назад» для возврата в меню.
   - «Рабочая область» показывает текущее состояние сигналов и предоставляет переключатели «Включить сигналы» / «Выключить сигналы». Переключение доступно только администраторам — остальным пользователям бот вернёт подсказку и оставит текущий статус.
   - Смена языка из меню не запускает повторную проверку подписки: пользователь сразу возвращается в главное меню на новом языке.

### Администрирование

- Команда `/admin` доступна только ID из `POCKET_BOT_ADMIN_IDS` (по умолчанию в список уже включён `503856039`). Администратору открывается панель с разделами:
   - **Ручной сигнал** — позволяет выбрать валютную пару, направление (вверх/вниз), время экспирации (0,5–5 минут или собственное значение) и отправить сигнал всем одобренным пользователям, у которых включён глобальный флаг сигналов. Бот автоматически подставляет актуальные значения `Current Value`, `Support(S1)` и `Resistance(R1)` с TradingView, прикладывает соответствующее изображение из каталога `images/` и дополняет карточку случайными показателями обзора рынка и аналогами индикаторов.
   - **Заявки** — отображает количество заявок в ожидании и рассылает карточки с кнопками «Одобрить» / «Отклонить».
   - **Глобальный флаг сигналов** — включает или выключает сигналы для рабочей области; текущее состояние показано в заголовке экрана.
   - **Список пользователей** — быстрый просмотр одобренных и отклонённых заявок.
   - **Настройки** — изменение рабочих часов в формате `ЧЧ:ММ-ЧЧ:ММ` и диапазона количества сигналов (например, `5-10`). Для ввода бот запрашивает значение и после сохранения показывает обновлённое состояние.
   - **Главное меню** — мгновенный переход к пользовательскому меню бота.
- При одобрении бот уведомляет пользователя и отправляет ему главное меню; при отклонении пользователь получает сообщение «Ваша заявка отклонена».

## Структура проекта

- `images/` — графические ресурсы (`language.png`, `main.png`, картинки для разделов меню и т. д.).
- `src/pocket_bot/` — исходные файлы бота.
  - `bot.py` — обработчики команд и построение приложения.
   - `config.py` — получение токена и списков администраторов из окружения или `.env`.
- `main.py` — точка входа для запуска.
- `requirements.txt` — зависимости проекта.
- `data/pocket_bot.sqlite3` — файл SQLite, который используется по умолчанию (можно удалить после перехода на MySQL).

## Дополнительно

- Никогда не храните настоящий токен в Git. Добавьте файл `.env` в `.gitignore`, если планируете публиковать репозиторий.
- Для продакшн-развёртывания рекомендуется запускать бота как сервис (systemd, Docker и т. п.) и использовать Webhook при необходимости.
- Если используете удалённую базу, регулярно создавайте резервные копии и следите за списком разрешённых IP-адресов.
